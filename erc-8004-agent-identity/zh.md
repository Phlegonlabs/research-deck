# ERC-8004：链上代理身份、声誉与验证

## 这是什么？

ERC-8004（"Trustless Agents"）是一个以太坊标准，给 AI 代理**持久的链上身份、声誉评分和工作验证**。这是代理网络缺失的信任层。

核心问题：A2A 告诉代理*怎么说话*。MCP 告诉它们*用什么工具*。AP2/x402 告诉它们*怎么付钱*。但没有一个回答：**这个代理是谁，我该不该信任它？**

ERC-8004 用三个链上注册表回答这个问题 — 身份、声誉和验证 — 作为单例合约部署在以太坊主网和 20+ 个 L2 上。

## 为什么重要

没有 ERC-8004，代理经济有信任缺口：

| 问题 | 没有 ERC-8004 | 有 ERC-8004 |
|------|-------------|------------|
| 发现 | 手动配置、人工白名单 | 按能力查询链上注册表 |
| 信任 | "相信我" 或组织边界 | 链上声誉历史 + 验证证明 |
| 问责 | 谁运行了这个代理？无可验证答案 | NFT 身份绑定钱包 + 域名 |
| 支付安全 | 先付钱，祈祷它能用 | 托管合约只在验证完成后释放 |
| 跨组织代理 | 需要预先存在的商业关系 | 通过共享信任层无许可交互 |

## 三个注册表

### 1. 身份注册表（你是谁？）

**ERC-721 NFT = 代理的护照。** 每个代理获得唯一的 `agentId` 令牌，指向链下注册文件。

```
┌────────────────────────────┐
│  身份注册表 (ERC-721)       │
│                             │
│  agentId: 22                │
│  owner: 0xABC...            │
│  agentURI: ipfs://Qm...     │──── 指向 ────┐
│  metadata: { key: value }   │               │
│  agentWallet: 0xDEF...      │               ▼
└────────────────────────────┘    ┌──────────────────────┐
                                  │  注册文件 (JSON)       │
                                  │                       │
                                  │  name: "Hotel Agent"  │
                                  │  services:            │
                                  │    - A2A 端点          │
                                  │    - MCP 端点          │
                                  │  x402Support: true    │
                                  │  supportedTrust:      │
                                  │    - reputation       │
                                  │    - tee-attestation  │
                                  └──────────────────────┘
```

**注册文件结构：**
```json
{
  "type": "https://eips.ethereum.org/EIPS/eip-8004#registration-v1",
  "name": "myAgentName",
  "description": "自然语言描述",
  "services": [
    {
      "name": "A2A",
      "endpoint": "https://agent.example/.well-known/agent-card.json",
      "version": "0.3.0"
    },
    {
      "name": "MCP",
      "endpoint": "https://mcp.agent.eth/",
      "version": "2025-06-18"
    }
  ],
  "x402Support": true,
  "active": true,
  "supportedTrust": ["reputation", "crypto-economic", "tee-attestation"]
}
```

**关键设计决策：**
- **ERC-721 基础**：可移植、可组合，兼容现有 NFT 基础设施
- **URI 元数据**：重数据在链下（IPFS/HTTPS），链上存指针
- **域名验证**：可选 `/.well-known/agent-registration.json` 证明 HTTPS 端点所有权
- **agentWallet 分离**：代理操作钱包 ≠ 所有者钱包。更改需要 EIP-712/ERC-1271 签名。NFT 转移时自动清除
- **跨链**：`agentRegistry` 格式为 `{namespace}:{chainId}:{contract}`

**核心 Solidity 接口：**
```solidity
function register(string agentURI, MetadataEntry[] calldata metadata)
    external returns (uint256 agentId);

function setAgentURI(uint256 agentId, string calldata newURI) external;

function setAgentWallet(uint256 agentId, address newWallet,
    uint256 deadline, bytes calldata signature) external;
```

### 2. 声誉注册表（我能信你吗？）

**来自真实交互的结构化反馈。** 不是单一评分 — 原始信号，消费者自行聚合。

**反馈值示例：**

| tag1 | 测量 | 示例 | value | decimals |
|------|------|------|-------|----------|
| `starred` | 质量 (0-100) | 87/100 | 87 | 0 |
| `uptime` | 可用性 (%) | 99.77% | 9977 | 2 |
| `successRate` | 任务完成率 (%) | 89% | 89 | 0 |
| `tradingYield` | 收益 (%) | -3.2% | -32 | 1 |
| `latency` | 响应时间 (ms) | 150ms | 150 | 0 |

**反作弊措施：**
- **禁止自评**：代理所有者/操作员不能给自己评分
- **客户端地址过滤**：`getSummary()` 要求明确的客户端地址 — 消费者选择信任谁的反馈，限制女巫攻击
- **可撤销**：反馈可撤销（标记，不删除）
- **只追加**：链上哈希不可删除 — 永久审计轨迹
- **x402 支付证明**：反馈文件包含 `proofOfPayment` 证明评论者确实付费使用了服务

**链下反馈文件：**
```json
{
  "agentId": 22,
  "clientAddress": "eip155:1:0xABC...",
  "value": 100,
  "tag1": "starred",
  "endpoint": "https://agent.example.com/GetPrice",
  "a2a": {
    "skills": ["book-hotel"],
    "taskId": "task-123"
  },
  "proofOfPayment": {
    "txHash": "0x00...",
    "chainId": "1"
  }
}
```

### 3. 验证注册表（你真的做了吗？）

**独立的工作验证。** 信任有了牙齿 — 不只是 "大家说它好"，而是 "我们能证明它做对了"。

**三个验证层级 — 安全性与价值成正比：**

| 层级 | 方法 | 成本 | 用途 | 原理 |
|------|------|------|------|------|
| 1 — 社交 | 仅声誉 | 免费 | 订外卖、低价值任务 | 查声誉分，无需验证 |
| 2 — 加密经济 | 质押再执行 | 中 | 数据分析、中价值 | 验证者质押 ETH，重新执行工作，做错被罚没 |
| 3 — 密码学 | zkML / TEE | 高 | 医疗诊断、大额交易 | 正确执行的数学证明 |

**托管模式 — 杀手级应用：**
```
IF (ValidationRegistry.read(jobHash) == TRUE)
THEN releasePayment()
```

智能合约锁定资金。只有当验证注册表确认工作正确完成时才释放支付。无需人类仲裁。这就是无信任的代理商务。

## 已部署合约

2026 年 1 月 29 日上线以太坊主网，及 20+ 网络：

| 合约 | 主网地址 |
|------|---------|
| 身份注册表 | `0x8004A169FB4a3325136EB29fA0ceB6D2e539a432` |
| 声誉注册表 | `0x8004BAa17C55a88189AE136b182e5fdA19dE9b63` |

也部署在：Base、Arbitrum、Polygon、Optimism、Avalanche、Celo、Gnosis、Linea、Scroll、Taiko、Monad、BSC + 测试网。

## 如何连接协议栈

```
┌───────────────────────────────────────────────────────┐
│  ERC-8004（信任层）                                     │
│  "这个代理是谁？我该信任它吗？"                           │
│                                                        │
│  身份 ──── 声誉 ──── 验证                               │
│  (谁)     (履历)    (工作证明)                           │
├───────────────────────────────────────────────────────┤
│  支付层                                                │
│  x402（微支付）│ AP2（授权令）│ ACP（结账）               │
├───────────────────────────────────────────────────────┤
│  协调层                                                │
│  A2A（代理间任务）                                      │
├───────────────────────────────────────────────────────┤
│  工具层                                                │
│  MCP（代理→工具访问）                                    │
└───────────────────────────────────────────────────────┘
```

**具体集成：**

| 协议 | ERC-8004 怎么连接 |
|------|-----------------|
| **A2A** | 注册文件列出 A2A 端点。链上身份增强 Agent Card 发现 |
| **MCP** | 注册文件列出 MCP 端点。V2 规范添加更深 MCP 支持 |
| **x402** | `x402Support: true` 标志。声誉反馈包含 `proofOfPayment` 交易哈希 |
| **AP2** | 授权令系统可引用 `agentId` 做问责。验证注册表为争议解决提供证明 |

**完整生命周期：**
1. 代理在身份注册表注册 → 获得 `agentId` NFT
2. 发布包含 A2A/MCP 端点的注册文件
3. 客户端通过注册表查询发现代理（按能力、信任模型过滤）
4. 客户端通过 A2A 委托任务
5. 代理使用 MCP 工具执行
6. 代理通过 x402 为服务付费
7. 客户端向声誉注册表提交反馈
8. 高价值工作：客户端通过验证注册表请求验证
9. 托管合约根据验证结果释放支付

## 作者

| 作者 | 组织 | 角色 |
|------|------|------|
| Marco De Rossi | MetaMask | 身份/钱包 |
| Davide Crapis | 以太坊基金会 | 协议设计 |
| Jordan Ellis | Google | A2A 集成 |
| Erik Reppel | Coinbase | x402/支付集成 |

以太坊基金会 dAI（去中心化 AI）团队将 ERC-8004 指定为战略基础设施。

## 权衡与问题

### 真实问题

| 问题 | 严重性 | 详情 |
|------|--------|------|
| 女巫攻击 | 高 | 恶意行为者创建多身份膨胀声誉。客户端过滤部分缓解但未解决 |
| 身份 ≠ 能力 | 高 | 有 NFT 证明你*存在*，不证明你*好用*。注册文件可以声称任何东西 |
| 验证者激励设计 | 高 | ERC-8004 故意将激励/罚没设计留给 "特定验证协议" |
| 规模 gas 成本 | 中 | 即使在 L2，数百万反馈条目和验证请求也会累积 |
| 存储耗尽 | 中 | 无界验证请求无限期存储挂起元组。DoS 向量 |
| 链下依赖 | 中 | 注册文件、反馈详情、验证证据都在链下。IPFS pin 消失则元数据丢失 |
| 合谋网络 | 中 | 代理可互相放大声誉。反馈循环扭曲信任信号 |

### ERC-8004 故意不做的事

规范刻意最小化。不处理：
- **支付**：无原生支付机制（x402/AP2 处理）
- **定价**：无市场或定价逻辑
- **商业模式**：无收入分成或佣金结构
- **声誉算法**：只有原始信号 — 聚合在链下
- **验证者经济**：无内置质押/罚没

这是设计选择，不是限制："一个新基础协议能做的最聪明的事是对上层保持无观点。"

### 先有鸡还是先有蛋

ERC-8004 要有用，代理需要注册，客户端需要查注册表。但：
- 没人查的话代理为什么要注册？
- 注册代理少的话客户端为什么要查？

经典网络效应引导问题。以太坊基金会 dAI 团队在通过开发者项目和会议推动采用，但仍在早期。

## 替代方案

| 替代方案 | 内容 | 权衡 |
|----------|------|------|
| 仅 A2A Agent Card | 自声明能力 | 无独立验证，无声誉历史 |
| AP2 白名单 | 手动策展可信代理 | 不可扩展，中心化把关 |
| ENS + 证明 | 基于域名的身份 | 无声誉或验证框架 |
| 自定义声誉系统 | 平台特定信任 | 孤立、不可移植、厂商锁定 |
| ERC-7007（可验证 AI） | AI 推理的 ZK 证明 | 聚焦模型验证，不是代理身份 |

## 可偷的模式

| 模式 | 内容 | 为什么重要 |
|------|------|-----------|
| NFT 即身份 | ERC-721 令牌 = 可移植、可组合的代理护照 | 兼容现有 NFT 基础设施 |
| 混合链上/链下 | 链上：指针 + 哈希。链下：完整数据 | 比全链上存储节省 95%+ 成本 |
| 客户端过滤声誉 | 消费者选择信任谁的反馈 | 无需许可访问的女巫攻击抵抗 |
| 分层验证 | 社交 → 加密经济 → 密码学 | 安全性与价值风险成正比 |
| 验证托管 | 智能合约只在验证工作后释放支付 | 无信任代理商务 — 无需人类仲裁 |
| 支付证明反馈 | 包含证明评论者付费的 tx hash | 将真实用户与虚假评论者分开 |
| 域名验证 | `/.well-known/agent-registration.json` | 证明代理控制其声称的 HTTPS 端点 |
| 渐进验证 | 每个 requestHash 多个响应 + tag | "软最终性" → "硬最终性" 分阶段验证 |

## 结论

**真实的**：ERC-8004 已部署在主网和 20+ 个 L2。合约能用。身份注册表就是标准 ERC-721。规范经过深思且最小化。

**未就绪的**：生态系统。注册代理极少。声誉聚合服务尚不存在。有正当激励设计的验证者网络是理论性的。V2 的更深 MCP/x402 集成仍在开发中。

**诚实评估**：ERC-8004 是代理身份的正确*形状* — 基于 NFT、可组合、分层信任。但它是等待采用的基础设施。验证托管模式真正强大，可能成为无信任代理商务的基础。是否发生在 ERC-8004 上，取决于 2026-2027 年的生态势头。

**今天该做的**：如果你在构建代理，去身份注册表注册。一笔交易的成本，让你的代理可被发现。不用等声誉生态成熟 — 早期注册者在信任层获得势头时有先发优势。
