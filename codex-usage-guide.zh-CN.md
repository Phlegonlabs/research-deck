# Codex 完整使用指南（融合 `.claude` 工作流）

## 0. 适用对象
面向有经验开发者，目标是把 Codex 用成可复用、可审计、可交付的工程系统，而不是一次性问答工具。

## 1. 先统一心智模型
Codex 的核心价值不是“写代码更快”，而是把整个研发链路标准化：
1. 任务路由（先判断规模与路径）
2. 计划拆解（先计划后执行）
3. 小步实施（每步可验证）
4. 质量门禁（类型、规范、测试）
5. 评审与提交（可追溯）

你的 `.claude` 已经有一套成熟流程，这份指南直接沿用该工作流并映射到 Codex。

## 2. 与你现有 `.claude` 流程的映射

### 2.1 入口与路由（对应 `start.md`）
每个新任务先做三件事：
1. 判断项目状态：新任务 / 进行中 / 有既有计划
2. 评估规模：小（<3 文件）/ 中（3-10 文件）/ 大（>10 文件或架构变更）
3. 选执行路径：
   - 小：直接实现
   - 中：任务清单 -> 实现
   - 大：先计划文档 -> 再实现

### 2.2 计划先行（对应 `plan.md`）
进入执行前必须有计划，最小结构：
1. Goal：一句话目标
2. Files：影响文件与变更意图
3. Steps：可在 20 分钟内完成的步骤
4. Risks：风险与缓解
5. Verification：如何证明完成

### 2.3 任务管理（对应 `task-management.md`）
在仓库根目录维护 `TASKS.md`：
1. 开工前先列任务
2. 仅允许一个 in-progress
3. 完成即打勾并切下一个
4. 任何 2 步以上任务都不能跳过 task 列表

建议状态格式：
- `[ ] Task` 待办
- `[ ] **-> Task**` 进行中
- `[x] ~~Task~~` 已完成

### 2.4 验证门禁（对应 `verify.md`）
合并前固定顺序：
1. TypeCheck：`npm run typecheck` 或 `npx tsc --noEmit`
2. Lint：`npm run lint` 或 `npx eslint .`
3. Test：`npm test`

规则：任何一项失败都要修复并重跑，三项全绿才可宣称完成。

### 2.5 自审与提交（对应 `review.md` / `commit.md`）
提交前：
1. `git diff` 做自审
2. 检查禁用项（any/enum/空 catch/console.log/硬编码 secret）
3. 只暂存相关文件（禁止 `git add .`）
4. 使用 conventional commit：`feat|fix|refactor|docs|test|chore`

## 3. 你规则中的“硬约束”落地
根据 `.claude/rules`，Codex 执行时默认遵守：

### 3.1 代码与类型约束（`forbidden.md`）
1. 禁用 `any`、`enum`、无理由 `as`、`@ts-ignore`
2. 禁止空 `catch`
3. 禁止生产环境 `console.log`
4. 不读 `.env`，不泄露密钥

### 3.2 架构演进策略（`zero-compat.md`）
1. 不做兼容层，不背历史包袱
2. 允许破坏旧格式，优先清理与升级
3. 删除废弃代码，不保留“兼容分支”

### 3.3 工程取舍原则（`pragmatism.md`）
1. 先做最简单可工作的方案
2. 不为假设场景过度设计
3. 不扩任务边界之外的重构

## 4. Codex 标准执行 SOP（可直接复用）

### 阶段 A：任务启动
1. 复述目标与验收标准
2. 读取上下文（代码、文档、最近提交）
3. 判断任务规模并选路径

### 阶段 B：计划与拆分
1. 输出 Goal/Files/Steps/Risks/Verification
2. 建立 `TASKS.md`
3. 锁定第一步并开始执行

### 阶段 C：实现
1. 小步改动，单步可回滚
2. 每步后运行最小必要验证
3. 保持 diff 干净，避免顺手大重构

### 阶段 D：质量门禁
1. TypeCheck
2. Lint
3. Test
4. 失败即修复并重跑

### 阶段 E：收尾交付
1. `git diff` 自审
2. 输出变更摘要与风险
3. 精准 `git add` + conventional commit

## 5. 三个高价值提示词模板

### 5.1 功能开发
```text
请按以下流程执行：任务路由 -> 计划 -> TASKS -> 实现 -> 验证 -> 自审。
约束：禁止 any/enum/空 catch/console.log，禁止读取 .env。
输出：
1) 计划（Goal/Files/Steps/Risks/Verification）
2) 变更文件列表
3) 验证结果（typecheck/lint/test）
4) 剩余风险
```

### 5.2 Bug 修复
```text
按“复现 -> 根因 -> 最小修复 -> 回归测试”处理。
先给根因假设和验证步骤，再动代码。
修复后必须补测试并给出验证日志摘要。
```

### 5.3 严格评审
```text
请按严重级审查当前变更：
- 行为错误/回归
- 类型与异常处理
- 安全泄露风险
- 可维护性与复杂度
- 测试缺口
每条问题需包含 file:line、影响、修复建议。
```

## 6. 研究与评估框架（Codex vs 其他 Agent）
统一任务集下对比：
1. 完成率：是否满足验收
2. 正确性：测试通过 + review 问题数
3. 效率：耗时、交互轮次、token 成本
4. 可维护性：复杂度、重复率、可读性
5. 稳定性：重复执行结果一致性

最少覆盖任务类型：
1. 新功能
2. 历史 bug 修复
3. 跨模块重构
4. 性能优化
5. 测试/文档补全

## 7. 团队落地建议（30 天）
1. 第 1 周：用 5 个中小任务试点，固化模板
2. 第 2 周：把 typecheck/lint/test 接入 CI 门禁
3. 第 3 周：建立质量/效率看板
4. 第 4 周：沉淀 SOP 与反模式清单

## 8. 快速检查清单（每日）
1. 任务是否有明确验收标准
2. 是否先计划再执行
3. 是否有 `TASKS.md` 且状态同步
4. 三道验证是否全绿
5. 是否完成自审并精准提交

---

如果你希望，我可以下一步再给你一份“命令速查版”（一页纸），把你 `.claude` 的 `/start /plan /verify /review /commit` 全部映射成 Codex 的标准操作短指令。
