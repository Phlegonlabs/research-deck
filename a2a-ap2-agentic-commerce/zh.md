# A2A、AP2、ACP：代理商务协议栈

## 解决什么问题？

AI 代理现在能推理和使用工具（通过 MCP），能为服务付费（通过 x402）。但还有两个关键缺口：

1. **代理间通信**：旅行代理怎么把酒店预订委托给酒店代理？MCP 连接代理和工具，不是代理和代理。
2. **可信商务**：代理代你买东西时，谁证明你授权了？出了问题谁负责？x402 处理微支付但没有授权框架。

Google 的 A2A 和 AP2，加上 OpenAI/Stripe 的 ACP，填补这些缺口。和 MCP、x402 一起组成完整的协议栈。

## 完整协议栈

```
┌─────────────────────────────────────────────────────┐
│                    身份 / 信任                        │
│              ERC-8004（链上声誉）                      │
├─────────────────────────────────────────────────────┤
│                      支付                            │
│  ┌──────────┐  ┌──────────┐  ┌──────────────────┐  │
│  │   x402    │  │   AP2    │  │      ACP         │  │
│  │ 加密微    │  │ 法币 +   │  │ 聊天商务          │  │
│  │ 支付      │  │ 加密     │  │ (Stripe 令牌)    │  │
│  │           │  │ 授权令   │  │                  │  │
│  └──────────┘  └──────────┘  └──────────────────┘  │
├─────────────────────────────────────────────────────┤
│                     协调                             │
│              A2A（代理间协议）                         │
│         任务委托、发现、流式传输                        │
├─────────────────────────────────────────────────────┤
│                    工具访问                           │
│              MCP（模型上下文协议）                      │
│         代理 ↔ API、数据库、工具                       │
└─────────────────────────────────────────────────────┘
```

| 层 | 协议 | 所有者 | 作用 |
|----|------|--------|------|
| 工具访问 | **MCP** | Anthropic | 代理连接工具/API（纵向） |
| 协调 | **A2A** | Google（150+ 合作伙伴） | 代理委托任务给其他代理（横向） |
| 支付（加密） | **x402** | Coinbase/Cloudflare | HTTP 原生稳定币微支付 |
| 支付（授权令） | **AP2** | Google（60+ 合作伙伴） | 加密授权 + 多轨道支付 |
| 支付（商务） | **ACP** | OpenAI/Stripe | 基于聊天的结账 + 共享支付令牌 |
| 身份 | **ERC-8004** | 社区 | 链上代理声誉和质押 |

**关键洞察**：这些是层，不是竞争者。没有 A2A 的 MCP = 孤立的代理。没有 AP2 的 A2A = 能说话但不能付钱的代理。没有 AP2 的 x402 = 没有问责的支付。

## A2A：代理间协议

### 是什么

A2A 是**代理间通信**的开放协议。想象 HTTP，但是代理和代理之间，而不是浏览器和服务器之间。

核心设计原则：**不透明代理**。代理不需要暴露内部（记忆、工具、推理链）来协作。只需发布能力并接受任务。

### 架构

```
客户端代理                                  远程代理
    │                                           │
    │── GET /.well-known/agent-card.json ──────>│
    │<── Agent Card（能力、技能）─────────────────│
    │                                           │
    │── tasks/send (JSON-RPC) ────────────────->│
    │<── Task { status: "working" } ────────────│
    │                                           │
    │── tasks/sendSubscribe (SSE 流) ──────────>│
    │<── TaskStatusUpdate ──────────────────────│
    │<── TaskArtifactUpdate ────────────────────│
    │<── Task { status: "completed" } ──────────│
```

### 核心概念

**Agent Card**（`/.well-known/agent-card.json`）：JSON 文档 — 代理的名片。包含身份、技能、支持的模态、认证要求和服务端点。

```json
{
  "name": "Hotel Booking Agent",
  "description": "Books hotels, manages reservations",
  "url": "https://hotel-agent.example.com",
  "capabilities": { "streaming": true, "pushNotifications": true },
  "skills": [
    { "id": "book-hotel", "name": "Book Hotel", "description": "Search and book hotel rooms" }
  ],
  "securitySchemes": { "oauth2": { "..." } }
}
```

**Task 生命周期**：工作单元，状态机推进。

```
submitted → working → completed
                   → failed
                   → canceled
            working → input-required → working（恢复）
```

**Messages**：任务执行期间的双向通信。支持文本、文件、结构化数据、表单。

**Artifacts**：远程代理产出的交付物 — 文档、图片、数据。

### 传输

- JSON-RPC 2.0 over HTTPS
- 三种模式：同步请求/响应、SSE 流式、异步推送通知（webhooks）
- 认证：API keys、OAuth2、OpenID Connect、mTLS
- 兼容现有 API 网关和企业 SSO

### A2A 解决了 MCP 不能解决的什么

| 维度 | MCP | A2A |
|------|-----|-----|
| 交互 | 代理 → 工具（调用函数） | 代理 → 代理（委托任务） |
| 状态 | 无状态工具调用 | 有状态长期运行任务 |
| 不透明性 | 工具内部通过 schema 暴露 | 代理内部隐藏 |
| 模态 | 结构化输入/输出 | 文本、文件、表单、音频、视频 |
| 发现 | 手动工具配置 | Agent Card 自动发现 |
| 多轮 | 单次请求/响应 | 持续对话 + 状态 |

**汽车修理厂类比**：MCP = 技师使用诊断扫描仪（工具）。A2A = 店长把任务分派给技师（代理）。

## AP2：代理支付协议

### 是什么

Google 的**带加密问责的代理支付**开放协议。核心创新：**授权令（Mandates）** — 加密签名的用户授权证明，创建不可否认的审计轨迹。

AP2 解决了其他协议都不解决的三个问题：
1. **授权**：证明用户确实批准了这次购买
2. **真实性**：证明代理的请求匹配用户的真实意图
3. **问责**：出了问题确定谁负责

### 授权令系统

三种加密凭证：

#### Cart Mandate（人在场）

用户在看着。他们看到购物车，批准，用设备签名。

```json
{
  "id": "cart_abc123",
  "total": { "currency": "USD", "value": 238.00 },
  "items": [{ "sku": "TICKET-001", "qty": 2, "price": 119.00 }],
  "merchant_signature": "sig_merchant_xyz",
  "user_signature": "sig_user_device_key",
  "payment_method_token": "tok_visa_4242",
  "timestamp": "2026-02-19T10:30:00Z"
}
```

用户（硬件密钥）和商家都加密签名。不可否认的证明。

#### Intent Mandate（人不在场）

用户委托未来购买："票一上线就买，每张不超过 $120。"

```json
{
  "natural_language_description": "Buy 2 concert tickets under $120 each",
  "required_refundability": true,
  "intent_expiry": "2026-03-01T00:00:00Z",
  "max_total": { "currency": "USD", "value": 240.00 },
  "user_cart_confirmation_required": false,
  "user_device_signature": "sig_device_key_abc"
}
```

代理在这些边界内行动。如果超出，授权令签名证明代理违反了授权。

#### Payment Mandate（给支付网络的）

向 Visa/Mastercard/发卡行发信号："这笔交易由 AI 代理发起" + 人在场/不在场标志。

### 角色架构

```
┌──────────┐         ┌──────────────┐         ┌──────────────┐
│   用户    │────────>│  购物代理      │────A2A──>│   商家端点    │
│           │ 意图    │  (SA)         │         │              │
└──────────┘         └──────┬───────┘         └──────┬───────┘
                            │                         │
                     ┌──────▼───────┐         ┌──────▼───────┐
                     │ 凭证提供者    │         │  商家支付     │
                     │ (CP)         │         │  处理器       │
                     │ 钱包、卡片   │         │  (MPP)       │
                     │ 令牌化       │         │              │
                     └──────┬───────┘         └──────┬───────┘
                            │                         │
                            └─────────────────────────┘
                                      │
                               ┌──────▼───────┐
                               │  网络/发卡行   │
                               │  (Visa 等)    │
                               └──────────────┘
```

六个角色严格分离职责：

| 角色 | 能看到 | 永远看不到 |
|------|--------|-----------|
| 购物代理 | 产品、价格、购物车 | 支付凭证、PCI 数据 |
| 凭证提供者 | 令牌化的支付方式 | 购物上下文 |
| 商家 | Cart mandate、签名授权 | 原始卡号 |
| 支付处理器 | Payment mandate、交易数据 | 用户完整购物历史 |

**关键**：购物代理永远接触不到原始支付凭证。只拿到令牌化的支付方式。这是核心架构约束。

### AP2 和 x402 怎么连接

AP2 是**支付轨道无关的**。V0.1 支持 "pull" 支付（卡）。未来版本加 "push" 支付 — 包括 x402 稳定币。

```
AP2 Mandate（授权层）
    │
    ├── 传统轨道：Visa/Mastercard/PayPal
    ├── 实时银行转账
    └── x402 稳定币结算 ← 这里
```

AP2 提供**信任和问责**（谁授权了什么）。x402 提供**结算**（即时链上支付）。一起用：
- AP2 Intent Mandate 设定消费限额和规则
- x402 处理每次 API 调用的微支付
- AP2 Payment Mandate 为每笔交易创建审计轨迹
- x402 在 Base/Solana 上结算

Google 有官方 demo 仓库：`google-agentic-commerce/a2a-x402`。

## ACP：代理商务协议

### 是什么

OpenAI 和 Stripe 的**聊天商务**协议。驱动 "ChatGPT Instant Checkout" — 在聊天中直接从 Shopify/Etsy 购买。

### 架构

比 AP2 简单 — 四个角色，不是六个：

| 角色 | 职责 |
|------|------|
| 买家 | 通过 AI 发现产品，授权支付 |
| AI 代理 | 展示产品、收集支付意图、管理结账 |
| 商家 | 接收结账请求，履行订单 |
| 支付提供者 | 发行共享支付令牌，处理收费 |

### 核心流程

```
买家 → "我想要蓝色运动鞋" → 代理
代理 → Create Checkout (SKU) → 商家 ACP 端点
商家 → 购物车 + 定价 → 代理 → 买家审核
买家 → "买吧" → 代理
代理 → 共享支付令牌 → 商家
商家 → Complete Checkout (via Stripe) → 确认
```

**Shared Payment Token**：Stripe 的关键创新。限定范围、限时、限量的令牌，让商家收费但看不到原始卡数据。

### ACP vs AP2

| 维度 | ACP | AP2 |
|------|-----|-----|
| 焦点 | 消费者结账 UX | 企业问责 |
| 复杂度 | 简单（4 角色） | 复杂（6 角色 + 授权令） |
| 认证模型 | 共享支付令牌 | 加密授权令 |
| 支付轨道 | Stripe 优先 | 轨道无关（卡 + 加密 + 银行） |
| 争议模型 | 标准 Stripe 争议 | 基于授权令的加密证据 |
| 今天能用？ | 是（ChatGPT Instant Checkout） | V0.1（仅人在场的卡支付） |
| 合作伙伴 | OpenAI、Stripe、Shopify、Etsy | Google、Mastercard、PayPal、60+ |
| 理念 | "让结账隐形" | "让交易可证明" |

**诚实评价**：ACP **已在生产中运行**，今天就能用。AP2 **架构更严谨** 但大部分还是 V0.1。按时间线选：现在用 ACP，企业级未来用 AP2。

## 所有东西怎么组合

### 代理商务完整流程

```
用户："帮我找飞东京的航班，800 以下，订最好的"
    │
    ▼
┌─────────────────────────────────────────────────────┐
│  个人代理（编排器）                                    │
│                                                      │
│  1. 用 MCP 查日历、检查预算                            │
│  2. 用 A2A 委托给航班搜索代理                          │
│  3. 航班代理用 MCP 调用航空 API                        │
│  4. 航班代理通过 A2A artifacts 返回选项                 │
│  5. 个人代理选择最佳选项                               │
│  6. 用 AP2 授权令授权支付                              │
│  7. 凭证提供者令牌化支付方式                            │
│  8. x402 在链上结算交易                                │
│     或 AP2 通过 Visa/Mastercard 路由                   │
│  9. 确认通过 A2A 回传                                  │
│                                                      │
│  每一步都有：加密证明、审计轨迹、                        │
│  消费限额、随时可以问人类                               │
└─────────────────────────────────────────────────────┘
```

### 协议交互矩阵

| 场景 | MCP | A2A | AP2 | ACP | x402 |
|------|-----|-----|-----|-----|------|
| 代理用数据库 | **是** | - | - | - | - |
| 代理委托任务给另一个代理 | - | **是** | - | - | - |
| 代理买东西（消费者） | - | - | - | **是** | - |
| 代理买东西（企业） | - | **是** | **是** | - | - |
| 代理为 API 调用付费 | - | - | - | - | **是** |
| 代理间付费服务 | - | **是** | 可选 | - | **是** |
| 需要争议解决 | - | - | **是** | Stripe | - |
| 多代理工作流 | **是** | **是** | **是** | - | **是** |

### "鲻鱼经济"

**前端（B2C）**：消费者和代理交互，用 ACP（ChatGPT 结账）或 AP2（Google Shopping）。熟悉的支付轨道：Visa、Mastercard、PayPal。受监管、有保险、有退款保护。

**后端（B2B/M2M）**：代理互相为 API 访问、数据、算力通过 x402 付费。即时稳定币结算。无需账户。机器速度、机器量级。

AP2 桥接两个世界：它可以用同一套授权令系统授权法币支付（前端）和 x402 稳定币支付（后端）。

## 权衡与问题

### A2A 问题

| 问题 | 严重性 | 详情 |
|------|--------|------|
| 发现碎片化 | 高 | Agent Card 的 well-known URI 适合公开代理；企业发现需要尚不存在的注册中心 |
| 认证复杂性 | 高 | 不同组织的代理间 OAuth2/mTLS 配置不简单 |
| 无经济层 | 中 | A2A 没有支付概念 — 需要 AP2/x402 叠加 |
| Google 主导 | 中 | 150+ 合作伙伴，但 Google 控制规范。Web3 中心化模式重演？ |

### AP2 问题

| 问题 | 严重性 | 详情 |
|------|--------|------|
| 仅 V0.1 | 致命 | 只有人在场的卡支付能用。自主 + 加密 = "计划中" |
| 授权令 UX | 高 | 用户必须签加密授权令。目前这个 UX 很糟糕 |
| 6 角色复杂度 | 高 | Cart Mandate → CP → Payment Mandate → 处理器 → 网络。集成点太多 |
| 白名单引导 | 高 | 短期信任靠手动白名单。无法扩展 |
| 无微支付方案 | 中 | AP2 授权令对 $0.001 的 API 调用太重。x402 更适合 |

### ACP 问题

| 问题 | 严重性 | 详情 |
|------|--------|------|
| Stripe 锁定 | 高 | "开放标准" 但共享支付令牌 = Stripe 优先 |
| 仅消费者 | 高 | 无企业审计轨迹，无加密授权令 |
| ChatGPT 中心 | 中 | 驱动 ChatGPT Instant Checkout。其他代理需自建 UX |
| 支付轨道有限 | 中 | 通过 Stripe 的信用卡/借记卡。无银行转账、无加密（暂时） |

### 元问题：标准太多

```
MCP + A2A + AP2 + ACP + x402 + ERC-8004 = 6 个协议
```

一次商务交易可能需要：MCP（工具）→ A2A（委托）→ AP2（授权）→ x402（结算）。4 层协议。集成复杂度是真的。

## 可偷的模式

| 模式 | 内容 | 为什么重要 |
|------|------|-----------|
| Agent Card 发现 | `/.well-known/agent-card.json` | 标准代理能力广告 — 即使不用 A2A 也有用 |
| Task 状态机 | submitted → working → input-required → completed | 任何长期运行代理交互的清洁生命周期模型 |
| 授权令系统 | 用户授权的加密证明 | 任何自主代理行动的问责，不只是支付 |
| 角色分离 | 代理 ≠ 支付处理 ≠ 凭证存储 | 永远不让 LLM 看到原始凭证 |
| 共享支付令牌 | 限范围、限时、限量 | 支付权限的安全委托 |
| 支付轨道抽象 | AP2 授权令 → 多种结算方式 | 将授权和结算解耦 |

## 时间线与成熟度

| 协议 | 状态 | 生产就绪？ |
|------|------|-----------|
| MCP | 稳定，广泛采用 | 是 |
| A2A | V0.2+，150+ 合作伙伴 | 是（基础），持续演进 |
| x402 | V2，1 亿+ 支付 | 是 |
| ACP | Beta，有版本化规范 | 是（ChatGPT 结账） |
| AP2 | V0.1，60+ 合作伙伴 | 部分（仅人在场卡支付） |
| ERC-8004 | 草案 | 否 |

## 结论

**今天真实可用的**：MCP（工具）+ x402（微支付）+ ACP（消费者结账）在生产中运行。A2A 基本代理委托可用。

**即将到来的**：AP2 自主授权令、AP2 + x402 集成、ACP 扩展到 ChatGPT 之外。

**诚实评估**：我们有太多协议，生产实现不够多。协议栈*在架构上合理* — 每层解决真实问题。但集成复杂度高，大部分还是 V0.1。

**应该构建的**：如果你今天在构建代理，用 MCP + x402 处理工具访问和微支付。需要多代理委托就加 A2A。观望 AP2 但别在 V1.x 之前押注。做消费者商务就在 ChatGPT 上用 ACP。

**$5T 问题**：McKinsey 预测 2030 年代理交易量 $3-5T。不管这些特定协议是赢还是被整合/替换，它们建立的*模式*（基于授权令的授权、支付轨道抽象、代理发现、角色分离）会持续下去。学模式，不只学 API。
